# TextPin 2.0 - 产品需求文档（PRD）

## 文档信息
- **产品名称**：TextPin
- **当前版本**：v2.0.0
- **文档版本**：2.0
- **最后更新**：2025-03-30

---

## 1. 产品概述

### 1.1 产品定位
**TextPin** 是一款专注于**剪贴板内容快速可视化**的桌面工具，通过悬浮贴卡的形式，让用户可以在任何应用上方快速查看、编辑和管理剪贴板文字内容。

### 1.2 核心价值
- **极速访问** - F4 快捷键瞬间创建贴卡
- **智能管理** - 自动过滤内部复制，历史记录去重
- **高度灵活** - 位置、大小、样式完全自定义
- **零干扰** - 轻量级，不影响其他应用使用

### 1.3 产品特色
- 📌 **贴卡模式** - 不是传统的单窗口编辑器，而是多贴卡系统
- 🎯 **智能过滤** - 自动识别并过滤贴卡内部复制
- 💾 **历史为先** - F4 始终从历史记录读取，可靠性高
- 🎨 **实时配置** - 所有设置立即应用，无需重启

---

## 2. 用户分析

### 2.1 目标用户
1. **程序员** - 频繁复制代码片段、日志、配置
2. **内容创作者** - 需要对比多段文字、临时记录灵感
3. **数据处理人员** - 处理大量文本数据，需要快速编辑
4. **办公人员** - 频繁在多个应用间复制粘贴文本

### 2.2 使用场景
| 场景 | 用户需求 | TextPin 解决方案 |
|------|---------|----------------|
| 代码调试 | 需要对比多段日志输出 | 创建多个贴卡，并排显示 |
| 文档编辑 | 临时记录多个引用来源 | 每个引用一个贴卡，随时查看 |
| 数据处理 | 复制数据后需要编辑再粘贴 | 在贴卡中编辑，一键复制结果 |
| 快速笔记 | 复制信息后想快速记录 | 贴卡悬浮，不遮挡工作窗口 |

---

## 3. 核心功能

### 3.1 贴卡管理（P0）

#### 3.1.1 创建贴卡
**触发方式**：
- 全局快捷键 F4（可自定义）
- 从历史记录双击

**创建逻辑**：
```
按 F4
  ↓
从历史记录读取最新内容
  ↓
创建贴卡窗口
  ↓
定位到鼠标位置（偏移 1px + 多贴卡偏移 25px）
  ↓
应用配置（尺寸、颜色、透明度）
```

**功能要求**：
- ✅ 必须支持同时创建多个贴卡
- ✅ 自动错开位置避免重叠
- ✅ 支持自动高度调整

#### 3.1.2 贴卡交互
| 操作 | 功能 | 实现方式 |
|------|------|---------|
| 拖动 | 移动贴卡位置 | 拖动上边缘 20px 区域 |
| 调整大小 | 改变贴卡尺寸 | 拖动四周边缘和四角 |
| 编辑 | 修改文本内容 | 直接在 QTextEdit 中编辑 |
| 复制 | 复制全部内容 | 点击"复制"按钮 |
| 关闭 | 删除贴卡 | 点击 ❌ 或 Alt+F4 |

#### 3.1.3 贴卡样式
可配置项：
- **尺寸**：默认宽度、默认高度
- **自动高度**：根据内容行数自动调整
- **透明度**：50-100%
- **字体**：字号、颜色
- **背景**：背景颜色

---

### 3.2 剪贴板监听（P0）

#### 3.2.1 自动监听
**功能描述**：自动捕获剪贴板文字变化并保存到历史

**配置项**：
- **自动监听剪贴板**：是否启用自动监听
  - ON：剪贴板变化 → 保存到历史
  - OFF：不监听，不保存

**实现逻辑**：
```python
剪贴板变化（QClipboard.dataChanged）
  ↓
检查：监听开关是否开启？
  ↓ 否 → 忽略
  ↓ 是
检查：内容是否为文本？
  ↓ 否 → 忽略
  ↓ 是
检查：忽略自身复制开关 + 焦点在贴卡内？
  ↓ 是 → 忽略
  ↓ 否
保存到 SQLite（content_hash 去重）
  ↓
如果设置窗口打开 → 刷新历史列表
```

#### 3.2.2 智能过滤
**功能描述**：过滤贴卡内部的复制操作

**过滤机制**：
1. **标记位检测**（优先级高）
   - 贴卡内复制/剪切时设置 `internal_copy_flag = True`
   - 延迟 300ms 自动重置
   
2. **焦点检测**（双重保险）
   - 检查 `QApplication.focusWidget().window()` 是否是贴卡

**配置项**：
- **忽略自身复制**：是否过滤贴卡内复制
  - ON：过滤
  - OFF：不过滤

---

### 3.3 历史记录（P0）

#### 3.3.1 数据存储
**数据表**：`clipboard_history`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| content | TEXT | 文本内容 |
| content_hash | TEXT | MD5 哈希（去重） |
| timestamp | DATETIME | 创建时间 |
| char_count | INTEGER | 字符数 |
| word_count | INTEGER | 单词数 |

**特性**：
- ✅ 使用 content_hash 自动去重
- ✅ UNIQUE 约束防止重复插入
- ✅ 按时间倒序排列

#### 3.3.2 历史管理
**功能**：
- 查看所有历史记录（最近 50 条）
- 搜索历史内容
- 双击创建贴卡
- 删除单条记录
- 清空全部历史

**实时更新**：
```python
剪贴板变化 → 保存到 SQLite
  ↓
检查：设置窗口是否打开？
  ↓ 是 → refresh_history()
  ↓ 否 → 不刷新（下次打开时加载）
```

---

### 3.4 设置系统（P1）

#### 3.4.1 设置窗口
**打开方式**：
- 点击系统托盘图标
- 程序启动时自动打开

**标签页**：
1. **常规** - 剪贴板监听、历史记录
2. **贴卡** - 尺寸、样式、透明度
3. **快捷键** - 自定义全局快捷键
4. **历史记录** - 查看和管理历史
5. **关于** - 版本信息

#### 3.4.2 实时应用
**设计原则**：所有设置立即生效，无需重启

**实现方式**：
- 设置变化 → 发送信号 → AppManager 接收 → 立即应用
- 使用信号槽机制：
  - `auto_monitor_changed`
  - `ignore_self_changed`
  - `hotkey_changed`
  - `card_style_changed`
  - `card_appearance_changed`

---

### 3.5 快捷键系统（P0）

#### 3.5.1 全局快捷键
**实现**：Windows RegisterHotKey API

**默认快捷键**：
- F4 - 创建贴卡

**可自定义**：
- 支持任意功能键（F1-F12）
- 支持修饰键：Ctrl、Alt、Shift、Win
- 实时注册，无需重启

#### 3.5.2 贴卡内快捷键
| 快捷键 | 功能 |
|--------|------|
| Ctrl+C | 复制选中 |
| Ctrl+V | 粘贴 |
| Ctrl+X | 剪切 |
| Ctrl+A | 全选 |
| Ctrl+F | 查找 |
| Ctrl+H | 替换 |

---

## 4. 技术架构

### 4.1 技术栈
- **语言**：Python 3.10+
- **GUI 框架**：PyQt6
- **数据库**：SQLite3
- **快捷键**：Windows API（ctypes）

### 4.2 项目结构
```
textpin/
├── main.py                    # 应用入口
├── core/                      # 核心模块
│   ├── app_manager.py         # 应用管理器（协调中心）
│   ├── clipboard_monitor.py   # 剪贴板监听
│   ├── hotkey_manager.py      # 全局快捷键
│   └── storage.py             # SQLite 存储
├── ui/                        # UI 模块
│   ├── card_window.py         # 贴卡窗口
│   ├── settings_window.py     # 设置窗口
│   ├── hotkey_edit.py         # 快捷键编辑
│   └── find_replace_dialog.py # 查找替换
└── utils/                     # 工具模块
    └── config.py              # 配置管理（JSON）
```

### 4.3 核心流程

#### 4.3.1 启动流程
```
main.py
  ↓
创建 AppManager
  ↓
初始化组件：
  - ConfigManager（配置）
  - StorageManager（数据库）
  - ClipboardMonitor（剪贴板）
  - HotkeyManager（快捷键）
  ↓
加载配置：
  - 自动监听开关
  - 忽略自身复制
  - 全局快捷键
  ↓
启动监听（如果开启）
注册快捷键
显示设置窗口
```

#### 4.3.2 创建贴卡流程
```
用户按 F4
  ↓
HotkeyManager 触发
  ↓
AppManager.create_card()
  ↓
从 StorageManager 读取历史最新记录
  ↓
创建 CardWindow
  ↓
应用配置：
  - 读取 card.default_width/height
  - 计算高度（如果 auto_height=true）
  - 设置透明度、字体、颜色
  ↓
定位：鼠标位置 + 偏移
  ↓
显示贴卡
```

#### 4.3.3 剪贴板监听流程
```
剪贴板变化
  ↓
ClipboardMonitor.dataChanged 信号
  ↓
_on_clipboard_changed()
  ↓
检查：监听开启？ → 否 → 结束
  ↓ 是
检查：内部复制标记？ → 是 → 忽略
  ↓ 否
检查：焦点在贴卡？ → 是 → 忽略
  ↓ 否
StorageManager.add_history()
  ↓
保存到 SQLite（去重）
  ↓
如果设置窗口打开 → 刷新列表
```

---

## 5. 数据设计

### 5.1 配置文件（config.json）
```json
{
    "clipboard": {
        "auto_monitor": true,
        "ignore_self": true,
        "max_history": 50
    },
    "card": {
        "default_width": 300,
        "default_height": 200,
        "auto_height": false,
        "opacity": 0.95,
        "font_size": 10,
        "font_color": "#000000",
        "bg_color": "#FFFFFF"
    },
    "hotkey": {
        "create_card": "F4"
    }
}
```

### 5.2 数据库设计（textpin.db）
**表：clipboard_history**
```sql
CREATE TABLE clipboard_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    content_hash TEXT UNIQUE NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    char_count INTEGER,
    word_count INTEGER
);

CREATE INDEX idx_timestamp ON clipboard_history(timestamp DESC);
CREATE INDEX idx_hash ON clipboard_history(content_hash);
```

---

## 6. 版本规划

### v2.0.0（当前版本）✅
**已完成功能**：
- 悬浮贴卡系统
- 全局快捷键
- 剪贴板监听
- 智能过滤
- 历史记录
- 实时配置
- 系统托盘

### v2.1.0（下一版本）
**计划功能**：
- 深色主题
- 贴卡模板（预设配色）
- 贴卡吸附功能
- 动画效果
- 贴卡分组
- 文本处理工具

**优先级排序**：
1. P0：深色主题
2. P1：贴卡模板系统
3. P1：文本处理工具
4. P2：动画效果
5. P2：贴卡吸附

### v3.0.0（长期规划）
**愿景功能**：
- Markdown 渲染
- 代码高亮
- 贴卡导出图片
- 跨平台支持
- 云同步
- 插件系统

---

## 7. 性能指标

### 7.1 性能目标
- **启动时间**：< 2 秒
- **快捷键响应**：< 100ms
- **贴卡创建**：< 200ms
- **内存占用**：< 50MB（基础状态）
- **数据库查询**：< 50ms

### 7.2 稳定性目标
- **崩溃率**：< 0.1%
- **快捷键注册成功率**：> 99%
- **数据持久化成功率**：100%

---

## 8. 用户体验

### 8.1 设计原则
1. **极简高效** - 核心操作不超过 2 步
2. **智能感知** - 自动识别用户意图
3. **实时反馈** - 所有操作立即生效
4. **零学习成本** - 符合用户直觉

### 8.2 交互设计
- **贴卡创建**：F4 → 瞬间出现（< 200ms）
- **贴卡移动**：拖拽上边缘，流畅跟随
- **大小调整**：8 个方向调整，实时预览
- **设置修改**：点击应用 → 立即生效

---

## 9. 未来展望

### 9.1 技术演进
- **AI 集成** - 智能文本总结、翻译
- **多设备同步** - 云端同步历史记录
- **协作功能** - 团队共享贴卡

### 9.2 生态建设
- **插件市场** - 第三方扩展
- **API 开放** - 支持自动化脚本
- **社区驱动** - 用户贡献模板和主题

---

## 附录

### A. 术语表
- **贴卡**：悬浮在桌面的文本卡片窗口
- **历史记录**：剪贴板捕获的文本内容列表
- **内部复制**：在贴卡窗口内的复制操作
- **智能过滤**：自动识别并忽略内部复制

### B. 参考资料
- PyQt6 官方文档
- Windows API 文档
- SQLite 文档

---

**文档结束**
